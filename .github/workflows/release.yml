name: Build and Upload Release Artifacts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_windows:
        description: 'Build Windows (.exe)'
        type: boolean
        default: true
        required: false
      run_macos:
        description: 'Build macOS (.dmg)'
        type: boolean
        default: true
        required: false
      run_ios:
        description: 'Build iOS (.ipa / .xcarchive)'
        type: boolean
        default: true
        required: false
      sign_mac:
        description: 'Sign and notarize macOS build (requires secrets)'
        type: boolean
        default: false
        required: false
      sign_ios:
        description: 'Sign iOS build (requires secrets)'
        type: boolean
        default: false
        required: false

jobs:
  setup:
    name: Setup & Versioning
    runs-on: ubuntu-latest
    outputs:
      APP_VERSION: ${{ steps.version.outputs.APP_VERSION }}
      RUN_WINDOWS: ${{ steps.filter.outputs.RUN_WINDOWS }}
      RUN_MACOS: ${{ steps.filter.outputs.RUN_MACOS }}
      RUN_IOS: ${{ steps.filter.outputs.RUN_IOS }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute version
        id: version
        shell: bash
        run: |
          set -euo pipefail
          RAW="${GITHUB_REF_NAME}"
          if [ "${{ github.event_name }}" = "release" ]; then RAW="${{ github.event.release.tag_name }}"; fi
          RAW=$(echo "$RAW" | tr -d '\r' | xargs)
          
          # Default to dev version
          VERSION="1.0.0-dev"
          
          # POSIX ERE-compatible SemVer check
          if [[ "$RAW" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            VERSION="${RAW#v}"
          else
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              echo "::error::Invalid tag format '$RAW'. Expected SemVer like v1.2.3"
              exit 1
            else
              echo "[INFO] Non-SemVer ref '$RAW'. Using fallback $VERSION for manual run."
            fi
          fi
          
          echo "APP_VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Computed version: $VERSION"

      - name: Determine jobs to run
        id: filter
        run: |
          RUN_WINDOWS="true"
          RUN_MACOS="true"
          RUN_IOS="true"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RUN_WINDOWS="${{ inputs.run_windows }}"
            RUN_MACOS="${{ inputs.run_macos }}"
            RUN_IOS="${{ inputs.run_ios }}"
          fi
          
          echo "RUN_WINDOWS=$RUN_WINDOWS" >> "$GITHUB_OUTPUT"
          echo "RUN_MACOS=$RUN_MACOS" >> "$GITHUB_OUTPUT"
          echo "RUN_IOS=$RUN_IOS" >> "$GITHUB_OUTPUT"

  build-windows:
    name: Build (Windows .exe)
    needs: setup
    if: ${{ needs.setup.outputs.RUN_WINDOWS == 'true' }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      # Placeholder for Windows Code Signing
      # - name: Sign Windows Application
      #   if: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 != '' }}
      #   run: |
      #     # Decode certificate and use signtool or similar
      #     # echo "${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}" | base64 --decode > cert.pfx
      #     # signtool sign /f cert.pfx /p "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" ...

      - name: Build release distribution
        shell: cmd
        env:
          APP_VERSION: ${{ needs.setup.outputs.APP_VERSION }}
        run: ./gradlew.bat -PappVersion=%APP_VERSION% packageReleaseDistributionForCurrentOS --stacktrace --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MtgPirate-Windows-${{ needs.setup.outputs.APP_VERSION }}
          path: build/compose/binaries/**/*.exe
          if-no-files-found: warn

  build-macos:
    name: Build (macOS .dmg)
    needs: setup
    if: ${{ needs.setup.outputs.RUN_MACOS == 'true' }}
    runs-on: macos-latest
    env:
      SIGN_MAC: ${{ (github.event_name == 'workflow_dispatch' && inputs.sign_mac) || secrets.SIGN_MAC || 'false' }}
      APP_VERSION: ${{ needs.setup.outputs.APP_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Import Apple code signing certificates
        if: ${{ env.SIGN_MAC == 'true' }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MACOS_P12_BASE64 }}
          p12-password: ${{ secrets.MACOS_P12_PASSWORD }}

      - name: Build release distribution
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
          MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
          MACOS_NOTARIZATION_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
        run: |
          ./gradlew -PappVersion=$APP_VERSION packageReleaseDistributionForCurrentOS --stacktrace --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MtgPirate-macOS-${{ env.APP_VERSION }}
          path: build/compose/binaries/**/*.dmg
          if-no-files-found: warn

  build-ios:
    name: Build (iOS .ipa/.xcarchive)
    needs: setup
    if: ${{ needs.setup.outputs.RUN_IOS == 'true' }}
    runs-on: macos-latest
    env:
      SIGN_IOS: ${{ (github.event_name == 'workflow_dispatch' && inputs.sign_ios) || secrets.SIGN_IOS || 'false' }}
      APP_VERSION: ${{ needs.setup.outputs.APP_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Import iOS code signing certificates
        if: ${{ env.SIGN_IOS == 'true' }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: Download Provisioning Profiles
        if: ${{ env.SIGN_IOS == 'true' }}
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Build iOS Archive
        run: |
          cd mtgPirate
          xcodebuild -project mtgPirate.xcodeproj \
            -scheme mtgPirate \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $PWD/build/mtgPirate.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="${{ env.SIGN_IOS == 'true' && secrets.IOS_CODE_SIGN_IDENTITY || '' }}" \
            MARKETING_VERSION=$APP_VERSION

      - name: Zip iOS Archive
        run: |
          cd mtgPirate/build
          zip -r mtgPirate.xcarchive.zip mtgPirate.xcarchive

      - name: Export IPA (if signed)
        if: ${{ env.SIGN_IOS == 'true' }}
        run: |
          cd mtgPirate
          # Create export options plist
          cat <<EOF > exportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath $PWD/build/mtgPirate.xcarchive \
            -exportOptionsPlist exportOptions.plist \
            -exportPath $PWD/build/ipa

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MtgPirate-iOS-${{ env.APP_VERSION }}
          path: |
            mtgPirate/build/mtgPirate.xcarchive.zip
            mtgPirate/build/ipa/*.ipa
          if-no-files-found: warn

  attach-to-release:
    name: Attach artifacts to GitHub Release
    needs: [setup, build-windows, build-macos, build-ios]
    if: ${{ github.event_name == 'release' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.ipa
            artifacts/**/*.xcarchive.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
