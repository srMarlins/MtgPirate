name: Build and Upload Release Artifacts

on:
  # Build on published releases and on version tags (e.g., v1.2.3)
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_windows:
        description: 'Build Windows (.exe)'
        type: boolean
        default: true
        required: false
      run_macos:
        description: 'Build macOS (.dmg)'
        type: boolean
        default: true
        required: false
      run_ios:
        description: 'Build iOS (.ipa / .xcarchive)'
        type: boolean
        default: true
        required: false
      sign_mac:
        description: 'Sign and notarize macOS build (requires secrets)'
        type: boolean
        default: false
        required: false
      sign_ios:
        description: 'Sign iOS build (requires secrets)'
        type: boolean
        default: false
        required: false
  push:
    tags:
      - 'v*'

# IMPORTANT: For signed builds, you must configure the following secrets in your repository:
# macOS:
# - MACOS_P12_BASE64: Base64 encoded .p12 certificate file
# - MACOS_P12_PASSWORD: Password for the .p12 file
# - MACOS_SIGNING_IDENTITY: Common Name of the signing certificate (e.g. "Developer ID Application: Name (ID)")
# - MACOS_NOTARIZATION_APPLE_ID: Apple ID for notarization
# - MACOS_NOTARIZATION_PASSWORD: App-specific password for notarization
#
# iOS:
# - IOS_P12_BASE64: Base64 encoded .p12 certificate file
# - IOS_P12_PASSWORD: Password for the .p12 file
# - IOS_PROVISIONING_PROFILE_BASE64: Base64 encoded .mobileprovision file
# - IOS_CODE_SIGN_IDENTITY: Common Name of the signing certificate (e.g. "Apple Distribution: Name (ID)")

jobs:
  build-windows:
    name: Build (Windows .exe)
    runs-on: windows-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_windows }}
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute version (SemVer from tag)
        shell: bash
        run: |
          set -euo pipefail
          RAW="${GITHUB_REF_NAME}"
          if [ "${{ github.event_name }}" = "release" ]; then RAW="${{ github.event.release.tag_name }}"; fi
          # Normalize (strip CR/LF and whitespace)
          RAW=$(echo "$RAW" | tr -d '\r' | xargs)
          # POSIX ERE-compatible SemVer (no non-capturing groups): optional leading v; optional pre-release and build metadata
          if [[ "$RAW" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            V="${RAW#v}"
            echo "APP_VERSION=$V" >> "$GITHUB_ENV"
          else
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "APP_VERSION=1.0.0-dev" >> "$GITHUB_ENV"
              echo "[INFO] Non-SemVer ref '$RAW'. Using fallback APP_VERSION=1.0.0-dev for manual run."
            else
              echo "::error::Invalid tag format '$RAW'. Expected SemVer like v1.2.3 or v1.2.3-rc.1+build.5";
              exit 1
            fi
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Build release distribution for current OS
        shell: cmd
        run: ./gradlew.bat -PappVersion=%APP_VERSION% packageReleaseDistributionForCurrentOS --stacktrace --no-daemon


      - name: Upload build artifacts (Windows installer only)
        uses: actions/upload-artifact@v4
        with:
          name: MtgPirate-Windows-${{ env.APP_VERSION }}
          path: |
            build/compose/binaries/**/*.exe
          if-no-files-found: warn

  build-macos:
    name: Build (macOS .dmg)
    runs-on: macos-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_macos }}
    permissions:
      contents: read
    env:
      SIGN_MAC: ${{ (github.event_name == 'workflow_dispatch' && inputs.sign_mac) || secrets.SIGN_MAC || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute version (SemVer from tag)
        shell: bash
        run: |
          set -euo pipefail
          RAW="${GITHUB_REF_NAME}"
          if [ "${{ github.event_name }}" = "release" ]; then RAW="${{ github.event.release.tag_name }}"; fi
          # Normalize (strip CR/LF and whitespace)
          RAW=$(echo "$RAW" | tr -d '\r' | xargs)
          # POSIX ERE-compatible SemVer: optional leading v; optional pre-release and build metadata
          if [[ "$RAW" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            V="${RAW#v}"
            echo "APP_VERSION=$V" >> "$GITHUB_ENV"
          else
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "APP_VERSION=1.0.0-dev" >> "$GITHUB_ENV"
              echo "[INFO] Non-SemVer ref '$RAW'. Using fallback APP_VERSION=1.0.0-dev for manual run."
            else
              echo "::error::Invalid tag format '$RAW'. Expected SemVer like v1.2.3 or v1.2.3-rc.1+build.5";
              exit 1
            fi
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Import Apple code signing certificates
        if: ${{ env.SIGN_MAC == 'true' }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MACOS_P12_BASE64 }}
          p12-password: ${{ secrets.MACOS_P12_PASSWORD }}

      - name: Build release distribution for current OS (signed/notarized if enabled)
        env:
          SIGN_MAC: ${{ env.SIGN_MAC }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
          MACOS_NOTARIZATION_APPLE_ID: ${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}
          MACOS_NOTARIZATION_PASSWORD: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}
        run: |
          ./gradlew --version
          ./gradlew -PappVersion=$APP_VERSION packageReleaseDistributionForCurrentOS --stacktrace --no-daemon

      - name: Upload build artifacts (macOS DMG only)
        uses: actions/upload-artifact@v4
        with:
          name: MtgPirate-macOS-${{ env.APP_VERSION }}
          path: |
            build/compose/binaries/**/*.dmg
          if-no-files-found: warn

  build-ios:
    name: Build (iOS .ipa/.xcarchive)
    runs-on: macos-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_ios }}
    permissions:
      contents: read
    env:
      SIGN_IOS: ${{ (github.event_name == 'workflow_dispatch' && inputs.sign_ios) || secrets.SIGN_IOS || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compute version (SemVer from tag)
        shell: bash
        run: |
          set -euo pipefail
          RAW="${GITHUB_REF_NAME}"
          if [ "${{ github.event_name }}" = "release" ]; then RAW="${{ github.event.release.tag_name }}"; fi
          RAW=$(echo "$RAW" | tr -d '\r' | xargs)
          if [[ "$RAW" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            V="${RAW#v}"
            echo "APP_VERSION=$V" >> "$GITHUB_ENV"
          else
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "APP_VERSION=1.0.0-dev" >> "$GITHUB_ENV"
            else
              echo "::error::Invalid tag format '$RAW'"; exit 1
            fi
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Import iOS code signing certificates
        if: ${{ env.SIGN_IOS == 'true' }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: Download Provisioning Profiles
        if: ${{ env.SIGN_IOS == 'true' }}
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      - name: Build iOS Archive
        run: |
          cd mtgPirate
          xcodebuild -project mtgPirate.xcodeproj \
            -scheme mtgPirate \
            -sdk iphoneos \
            -configuration Release \
            -archivePath $PWD/build/mtgPirate.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="${{ env.SIGN_IOS == 'true' && secrets.IOS_CODE_SIGN_IDENTITY || '' }}"

      - name: Zip iOS Archive
        run: |
          cd mtgPirate/build
          zip -r mtgPirate.xcarchive.zip mtgPirate.xcarchive

      - name: Export IPA (if signed)
        if: ${{ env.SIGN_IOS == 'true' }}
        run: |
          cd mtgPirate
          # Create a dummy export options plist if one doesn't exist
          # In a real setup, you might want to check in a template or generate one dynamically
          cat <<EOF > exportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath $PWD/build/mtgPirate.xcarchive \
            -exportOptionsPlist exportOptions.plist \
            -exportPath $PWD/build/ipa

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MtgPirate-iOS-${{ env.APP_VERSION }}
          path: |
            mtgPirate/build/mtgPirate.xcarchive.zip
            mtgPirate/build/ipa/*.ipa
          if-no-files-found: warn

  attach-to-release:
    name: Attach artifacts to GitHub Release
    needs: [build-windows, build-macos, build-ios]
    if: ${{ github.event_name == 'release' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.ipa
            artifacts/**/*.xcarchive.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
